<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë¯¸ë””ì–´ì•„íŠ¸ ìœµí•©êµìœ¡ ì›¹ì „ì‹œ í”Œë«í¼</title>
    <style>
        /* 1. ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f4f4f4; margin: 0; padding: 0; }
        header { background-color: #333; color: white; padding: 20px; text-align: center; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        #loading-message { text-align: center; color: #555; padding: 50px; }

        /* 2. ì‘í’ˆ ê°¤ëŸ¬ë¦¬ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
        #art-gallery {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 25px; 
            padding: 20px 0;
        }
        .art-piece {
            /* widthëŠ” JavaScriptì—ì„œ frameWidth ê°’ìœ¼ë¡œ ì„¤ì •ë¨ */
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            text-align: center;
            cursor: pointer; 
            transition: transform 0.2s;
        }
        .art-piece:hover {
            transform: translateY(-5px); 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .art-piece h3 { font-size: 1.1em; margin: 10px 0 5px 0; color: #007bff; }
        .art-piece p { font-size: 0.9em; color: #666; margin: 5px 10px 10px 10px; }

        /* 3. iframe ìŠ¤íƒ€ì¼ (í†µì¼ëœ ê·œê²© í™•ë³´) */
        .art-frame {
            border: none;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <header>
        <h1 id="page-title">AI ë¯¸ë””ì–´ì•„íŠ¸ ì›¹ì „ì‹œ (ë¡œë”© ì¤‘...)</h1>
        <p id="class-info">GitHub Pagesë¥¼ ì´ìš©í•œ ì €ë¹„ìš©Â·ê³ í™•ì¥ ìœµí•©êµìœ¡ ì „ì‹œ í”Œë«í¼</p>
    </header>

    <div class="container">
        <div id="loading-message">ì‘í’ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        <div id="art-gallery">
            </div>
    </div>

    <script>
        // --- JavaScript ë°ì´í„° ë¡œë“œ ë° ë™ì  ë Œë”ë§ ë¡œì§ (ìµœì¢… ê°œì„  ë²„ì „) ---

        // 1. URL ë§¤ê°œë³€ìˆ˜ ì½ê¸°
        const params = new URLSearchParams(window.location.search);
        const sessionCode = params.get('class');
        const frameWidth = params.get('width') || 500;
        const frameHeight = params.get('height') || 400;
        const sheetCSVUrl = params.get('sheet');

        const gallery = document.getElementById('art-gallery');
        const loadingMessage = document.getElementById('loading-message');

        // *************** [í•µì‹¬ ì¸ë±ìŠ¤ ì •ì˜] Google Sheet ì»¬ëŸ¼ ìˆœì„œì— ë§ì¶¤ (A=0, B=1...) ***************
        const SESSION_CODE_INDEX = 1;  // Bì—´: 'í•´ë‹¹ ìˆ˜ì—…ì„ ì„ íƒí•˜ì„¸ìš”.'
        const TITLE_INDEX = 2;         // Cì—´: 'ì‘í’ˆ ì œëª©ì„ ì“°ì„¸ìš”.'
        const AUTHOR_INDEX = 3;        // Dì—´: 'ë§Œë“  í•™ìƒ ì´ë¦„ì„ ëª¨ë‘ ì“°ì„¸ìš”. (ì˜ˆ: í™ê¸¸ë™, í™ê¸¸ìˆœ, ...)'
        // Eì—´ (ì¸ë±ìŠ¤ 4)ëŠ” ê±´ë„ˆëœ€
        const IFRAME_INDEX = 5;        // Fì—´: 'p5.jsì—ì„œ iframeì„ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (íŒŒì¼>ê³µìœ >ì²«ë²ˆì§¸ íƒœê·¸)'
        const DESC_INDEX = 6;          // Gì—´: 'ì‘í’ˆì— ëŒ€í•œ ì„¤ëª…ì„ ì“°ì„¸ìš”.'
        // ******************************************************************************************

        // URL ë§¤ê°œë³€ìˆ˜ ìœ íš¨ì„± ê²€ì‚¬
        if (!sessionCode || !sheetCSVUrl) {
            loadingMessage.innerHTML = 'âš ï¸ **ì˜¤ë¥˜:** URLì— `class` (ì„¸ì…˜ ì½”ë“œ) ë˜ëŠ” `sheet` (CSV ì£¼ì†Œ) ë§¤ê°œë³€ìˆ˜ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. êµì‚¬ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.';
        } else {
            document.getElementById('page-title').innerText = `${sessionCode} ì‘í’ˆ ì „ì‹œíšŒ`;
            document.getElementById('class-info').innerText = 'í´ë¦­í•˜ë©´ ì‘í’ˆì„ í™•ëŒ€í•˜ì—¬ ê°ìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            loadData(sheetCSVUrl);
        }

        /**
         * Google Sheets CSV ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ì„œ íŒŒì‹±í•©ë‹ˆë‹¤.
         */
        function loadData(url) {
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ì˜¤ë¥˜! ìƒíƒœ: ${response.status}`);
                    }
                    return response.text();
                })
                // loadData í•¨ìˆ˜ ë‚´ë¶€ì˜ .then(csvText => { ... }) ë¶€ë¶„
                .then(csvText => {
                    // ********* [ë””ë²„ê¹… ì¶”ê°€] *********
                    console.log("--- 1. CSV í…ìŠ¤íŠ¸ ê¸¸ì´ ---");
                    console.log("ê¸¸ì´:", csvText.length);
                    console.log("--- 2. CSV í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸° (ì• 200ì) ---");
                    console.log(csvText.substring(0, 200));
                    // *********************************
                
                    loadingMessage.style.display = 'none';
                    const artworks = parseCSV(csvText);
                    renderGallery(artworks);
                })
                .catch(error => {
                    console.error('ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', error);
                    loadingMessage.innerHTML = 'âš ï¸ **ì˜¤ë¥˜:** ì‘í’ˆ ë°ì´í„° ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (CSV ì£¼ì†Œ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜)';
                });
        }

        /**
         * CSV í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•˜ì—¬ ë°°ì—´ ë°°ì—´ (2ì°¨ì› ë°°ì—´)ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. (ê°€ì¥ ê²¬ê³ í•œ íŒŒì‹±)
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length <= 1) return [];

            const data = [];
            
            // í—¤ë”(ì²« ì¤„)ë¥¼ ì œì™¸í•˜ê³  ë°ì´í„°ë§Œ ì²˜ë¦¬
            for (let i = 1; i < lines.length; i++) {
                let currentLine = lines[i];
                if (currentLine.trim() === '') continue;

                const values = [];
                let current = '';
                let inQuote = false;
                
                // í•œ ê¸€ìì”© ìˆœíšŒí•˜ë©° ë”°ì˜´í‘œ ì•ˆì˜ ì‰¼í‘œë¥¼ ë¬´ì‹œí•˜ê³  í•„ë“œë¥¼ ë¶„ë¦¬í•©ë‹ˆë‹¤.
                for (let j = 0; j < currentLine.length; j++) {
                    const char = currentLine[j];
                    
                    if (char === '"') {
                        inQuote = !inQuote;
                    } else if (char === ',' && !inQuote) {
                        values.push(current.trim().replace(/^"|"$/g, ''));
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                // ë§ˆì§€ë§‰ í•„ë“œ ì¶”ê°€
                values.push(current.trim().replace(/^"|"$/g, ''));

                // ìœ íš¨í•œ í–‰ë§Œ ì¶”ê°€
                if (values.length > 1) {
                    data.push(values);
                }
            }
            return data;
        }


        /**
         * í•„í„°ë§ëœ ë°ì´í„°ë¥¼ ê°¤ëŸ¬ë¦¬ì— ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderGallery(data) {
            
            // ğŸš¨ í•„í„°ë§: ì»¬ëŸ¼ ì¸ë±ìŠ¤ 1 (Bì—´)ì„ ì‚¬ìš©í•˜ì—¬ ì„¸ì…˜ ì½”ë“œë¥¼ ë¹„êµí•©ë‹ˆë‹¤. (ì•ˆì „)
            const filteredArtworks = data.filter(row => row[SESSION_CODE_INDEX] && row[SESSION_CODE_INDEX].trim() === sessionCode);
            
            if (filteredArtworks.length === 0) {
                gallery.innerHTML = `<p style="text-align: center; color: #ff5722;">ğŸ˜­ **ì˜¤ë¥˜:** '${sessionCode}'ì— í•´ë‹¹í•˜ëŠ” ì‘í’ˆì´ ë°ì´í„°ë² ì´ìŠ¤ì— ì—†ìŠµë‹ˆë‹¤.<br>1. ì„¸ì…˜ ì½”ë“œ ë„ì–´ì“°ê¸°(ê³µë°±)ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.<br>2. Google Sheetì˜ ë°ì´í„°ê°€ ìµœì‹  ìƒíƒœì¸ì§€ (ì¬ê²Œì‹œ) í™•ì¸í•´ì£¼ì„¸ìš”.</p>`;
                return;
            }
            
            // ********* [ë””ë²„ê¹… ì¶”ê°€: í•„í„°ë§ ì„±ê³µ ë©”ì‹œì§€] *********
            console.log(`--- 5. í•„í„°ë§ ì„±ê³µ: ${filteredArtworks.length}ê°œì˜ ì‘í’ˆ ë¡œë“œ ì‹œë„ ---`);
            // *******************************************************


            filteredArtworks.forEach(row => {
                const artPiece = document.createElement('div');
                artPiece.className = 'art-piece';
                artPiece.style.width = `${frameWidth}px`; 

                // iframe íƒœê·¸ì—ì„œ src ì£¼ì†Œ ì¶”ì¶œ (Fì—´, ì¸ë±ìŠ¤ 5)
                const iframeFullText = row[IFRAME_INDEX] || '';
                
                // --- í•µì‹¬ ìˆ˜ì •: ì •ê·œì‹ ì¬í™•ì¸ ë° ë¬¸ìì—´ ì •ë¦¬ ---
                // 1. ë¬¸ìì—´ ì•ë’¤ì˜ ê³µë°±/ì¤„ë°”ê¿ˆ ì œê±°
                const cleanIframeText = iframeFullText.trim(); 
                
                // 2. /src\s*=\s*['"]([^'"]+)['"]/i  <-- ë”ìš± ê°•ë ¥í•˜ê³  ìœ ì—°í•œ ì •ê·œì‹
                const iframeMatch = cleanIframeText.match(/src\s*=\s*['"]([^'"]+)['"]/i);
                
                if (!iframeMatch || !iframeMatch[1]) {
                    // ì˜¤ë¥˜ ë©”ì‹œì§€ ìˆ˜ì •: ì½˜ì†”ì—ì„œ ì‘í’ˆ ì œëª© ì¶œë ¥
                    console.warn(`[SKIP] ìœ íš¨í•œ iframe URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${row[TITLE_INDEX]}. ì¸ë±ìŠ¤ ${IFRAME_INDEX}ì˜ ë°ì´í„° í˜•íƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
                    // *****************************************
                    return; 
                } 
                
                const p5jsSrcUrl = iframeMatch[1];
                artPiece.dataset.url = p5jsSrcUrl; 
                
                // ë Œë”ë§ ì •ë³´ ì„¤ì •
                const artTitle = row[TITLE_INDEX] || 'ì œëª© ì—†ìŒ';
                const artAuthor = row[AUTHOR_INDEX] || 'ì‘ê°€ ì •ë³´ ì—†ìŒ';
                const artDesc = (row[DESC_INDEX] || '').substring(0, 50); 
                
                // HTML ë™ì  ìƒì„±
                const iframeHtml = `
                    <iframe 
                        class="art-frame" 
                        data-src="${p5jsSrcUrl}" 
                        width="${frameWidth}" 
                        height="${frameHeight}" 
                        frameborder="0"
                        allowfullscreen 
                        sandbox="allow-scripts allow-pointer-lock allow-same-origin allow-popups" 
                    ></iframe>
                    <h3>${artTitle}</h3>
                    <p>ì‘ê°€: ${artAuthor} | ${artDesc}${row[DESC_INDEX] && row[DESC_INDEX].length > 50 ? '...' : ''}</p>
                `;

                artPiece.innerHTML = iframeHtml;
                gallery.appendChild(artPiece);
            });
            
            // ì§€ì—° ë¡œë“œ ë° í™•ëŒ€ ë³´ê¸° ê¸°ëŠ¥ í™œì„±í™”
            activateFeatures();
        }
        
        // --- ì§€ì—° ë¡œë“œ(Lazy Loading) ë° í™•ëŒ€ ë³´ê¸° ê¸°ëŠ¥ í•¨ìˆ˜ ---
        function activateFeatures() {
            // Intersection Observer ì„¤ì • (ì§€ì—° ë¡œë“œ)
            const lazyArtFrames = document.querySelectorAll('.art-frame');
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const iframe = entry.target;
                        if (iframe.dataset.src) {
                            iframe.src = iframe.dataset.src;
                            iframe.removeAttribute('data-src');
                        }
                        observer.unobserve(iframe);
                    }
                });
            }, {
                rootMargin: '0px 0px 200px 0px', 
            });

            lazyArtFrames.forEach(iframe => {
                observer.observe(iframe);
            });

            // ì‘í’ˆ í™•ëŒ€ ë³´ê¸° ê¸°ëŠ¥ (ìƒˆ ì°½ íŒì—…)
            document.querySelectorAll('.art-piece').forEach(piece => {
                piece.addEventListener('click', function() {
                    const p5jsUrl = this.dataset.url;
                    const popupWidth = Math.min(parseInt(frameWidth) + 300, 1200); 
                    const popupHeight = Math.min(parseInt(frameHeight) + 200, 800);

                    if (p5jsUrl) {
                        window.open(
                            p5jsUrl, 
                            '_blank', 
                            `width=${popupWidth},height=${popupHeight},scrollbars=yes,resizable=yes`
                        );
                    }
                });
            });
        }
    </script>
</body>
</html>
