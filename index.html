<script>
        // --- 2-3, 2-4. JavaScript ë°ì´í„° ë¡œë“œ ë° ë™ì  ë Œë”ë§ ë¡œì§ ---

        // 1. URL ë§¤ê°œë³€ìˆ˜ ì½ê¸°
        const params = new URLSearchParams(window.location.search);
        const sessionCode = params.get('class'); // ìˆ˜ì—… ì„¸ì…˜ ì½”ë“œ (í•„í„°ë§ í‚¤)
        const frameWidth = params.get('width') || 500; // ì‘í’ˆ ê°€ë¡œ ê·œê²© (ê¸°ë³¸ê°’ 500)
        const frameHeight = params.get('height') || 400; // ì‘í’ˆ ì„¸ë¡œ ê·œê²© (ê¸°ë³¸ê°’ 400)
        const sheetCSVUrl = params.get('sheet'); // êµ¬ê¸€ ì‹œíŠ¸ CSV ì£¼ì†Œ

        const gallery = document.getElementById('art-gallery');
        const loadingMessage = document.getElementById('loading-message');

        // *************** [ìˆ˜ì •ëœ ë¶€ë¶„] Google Sheet í—¤ë”ì— ë§ì¶¤ ***************
        const sessionKey = 'í•´ë‹¹ ìˆ˜ì—…ì„ ì„ íƒí•˜ì„¸ìš”.'; 
        const iframeKey = 'p5.jsì—ì„œ iframeì„ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (íŒŒì¼>ê³µìœ >ì²«ë²ˆì§¸ íƒœê·¸)';
        const titleKey = 'ì‘í’ˆ ì œëª©ì„ ì“°ì„¸ìš”.';
        const authorKey = 'ë§Œë“  í•™ìƒ ì´ë¦„ì„ ëª¨ë‘ ì“°ì„¸ìš”. (ì˜ˆ: í™ê¸¸ë™, í™ê¸¸ìˆœ, ...)';
        const descKey = 'ì‘í’ˆì— ëŒ€í•œ ì„¤ëª…ì„ ì“°ì„¸ìš”.';
        // *******************************************************************
        
        // URL ë§¤ê°œë³€ìˆ˜ ìœ íš¨ì„± ê²€ì‚¬
        if (!sessionCode || !sheetCSVUrl) {
            loadingMessage.innerHTML = 'âš ï¸ **ì˜¤ë¥˜:** URLì— `class` (ì„¸ì…˜ ì½”ë“œ) ë˜ëŠ” `sheet` (CSV ì£¼ì†Œ) ë§¤ê°œë³€ìˆ˜ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. êµì‚¬ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.';
        } else {
            // í˜ì´ì§€ ì œëª© ì—…ë°ì´íŠ¸
            document.getElementById('page-title').innerText = `${sessionCode} ì‘í’ˆ ì „ì‹œíšŒ`;
            document.getElementById('class-info').innerText = 'í´ë¦­í•˜ë©´ ì‘í’ˆì„ í™•ëŒ€í•˜ì—¬ ê°ìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            loadData(sheetCSVUrl);
        }

        /**
         * Google Sheets CSV ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ì„œ íŒŒì‹±í•©ë‹ˆë‹¤.
         */
        function loadData(url) {
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ì˜¤ë¥˜! ìƒíƒœ: ${response.status}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    loadingMessage.style.display = 'none';
                    const artworks = parseCSV(csvText);
                    renderGallery(artworks);
                })
                .catch(error => {
                    console.error('ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', error);
                    loadingMessage.innerHTML = 'âš ï¸ **ì˜¤ë¥˜:** ì‘í’ˆ ë°ì´í„° ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (CSV ì£¼ì†Œ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ)';
                });
        }

        /**
         * CSV í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•˜ì—¬ ê°ì²´ ë°°ì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return [];
            
            // ì²« ì¤„ì„ í—¤ë”(ì—´ ì´ë¦„)ë¡œ ì‚¬ìš©
            // ì‰¼í‘œë¡œ êµ¬ë¶„ëœ CSV í—¤ë”ë¥¼ ì¶”ì¶œí•˜ê³  ë”°ì˜´í‘œ ì œê±°
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                // CSV íŒŒì‹±: ë”°ì˜´í‘œ ì•ˆì˜ ì‰¼í‘œëŠ” ë¬´ì‹œí•˜ë„ë¡ ì •ê·œí‘œí˜„ì‹ ì‚¬ìš© (ì¢€ ë” ê²¬ê³ í•œ ì²˜ë¦¬)
                const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/^"|"$/g, ''));
                if (values.length !== headers.length) continue; 

                let entry = {};
                headers.forEach((header, index) => {
                    entry[header] = values[index];
                });
                data.push(entry);
            }
            return data;
        }


        /**
         * í•„í„°ë§ëœ ë°ì´í„°ë¥¼ ê°¤ëŸ¬ë¦¬ì— ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderGallery(data) {
            
            // ğŸš¨ í•„í„°ë§: URLì˜ sessionCodeì™€ Google Sheetì˜ sessionKey ê°’ì´ ì¼ì¹˜í•˜ëŠ” í•­ëª©ë§Œ í•„í„°ë§
            const filteredArtworks = data.filter(item => item[sessionKey] && item[sessionKey].trim() === sessionCode);
            
            if (filteredArtworks.length === 0) {
                // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ì¢€ ë” ëª…í™•í•˜ê²Œ ìˆ˜ì •
                gallery.innerHTML = `<p style="text-align: center; color: #ff5722;">ğŸ˜­ **ì˜¤ë¥˜:** '${sessionCode}'ì— í•´ë‹¹í•˜ëŠ” ì‘í’ˆì´ ë°ì´í„°ë² ì´ìŠ¤ì— ì—†ìŠµë‹ˆë‹¤.<br>1. ì„¸ì…˜ ì½”ë“œ ë„ì–´ì“°ê¸°(ê³µë°±)ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.<br>2. Google Sheetì˜ ë°ì´í„°ê°€ ìµœì‹  ìƒíƒœì¸ì§€ í™•ì¸(ì¬ê²Œì‹œ)í•´ì£¼ì„¸ìš”.</p>`;
                return;
            }

            filteredArtworks.forEach(art => {
                const artPiece = document.createElement('div');
                artPiece.className = 'art-piece';
                artPiece.style.width = `${frameWidth}px`; // ì»¨í…Œì´ë„ˆ ë„ˆë¹„ ì„¤ì •

                // iframe íƒœê·¸ì—ì„œ src ì£¼ì†Œ ì¶”ì¶œ (ì‘í’ˆ í™•ëŒ€ ë³´ê¸°ì— ì‚¬ìš©)
                // iframe íƒœê·¸ëŠ” 4ì—´ì— ì €ì¥ëœ ì „ì²´ ë¬¸ìì—´ì…ë‹ˆë‹¤.
                const iframeFullText = art[iframeKey] || '';
                const iframeMatch = iframeFullText.match(/src="([^"]+)"/);
                
                if (!iframeMatch || !iframeMatch[1]) {
                    // iframe íƒœê·¸ê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ ì‘í’ˆì€ ê±´ë„ˆë›°ê³  ì½˜ì†”ì— ê¸°ë¡
                    console.warn(`[SKIP] ìœ íš¨í•œ iframe URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${art[titleKey]}`);
                    return; 
                } 
                
                const p5jsSrcUrl = iframeMatch[1];
                artPiece.dataset.url = p5jsSrcUrl; // í™•ëŒ€ ë³´ê¸°ë¥¼ ìœ„í•´ URL ì €ì¥
                
                // 2-4. í†µì¼ëœ ê·œê²©ì˜ iframe HTML ìƒì„± (ì§€ì—° ë¡œë“œë¥¼ ìœ„í•´ src ëŒ€ì‹  data-src ì‚¬ìš©)
                const artTitle = art[titleKey] || 'ì œëª© ì—†ìŒ';
                const artAuthor = art[authorKey] || 'ì‘ê°€ ì •ë³´ ì—†ìŒ';
                const artDesc = (art[descKey] || '').substring(0, 50); // ì„¤ëª…ì€ 50ìë§Œ ë¯¸ë¦¬ ë³´ê¸°
                
                const iframeHtml = `
                    <iframe 
                        class="art-frame" 
                        data-src="${p5jsSrcUrl}" 
                        width="${frameWidth}" 
                        height="${frameHeight}" 
                        frameborder="0"
                        allowfullscreen 
                        sandbox="allow-scripts allow-pointer-lock allow-same-origin allow-popups" 
                    ></iframe>
                    <h3>${artTitle}</h3>
                    <p>ì‘ê°€: ${artAuthor} | ${artDesc}${art[descKey] && art[descKey].length > 50 ? '...' : ''}</p>
                `;

                artPiece.innerHTML = iframeHtml;
                gallery.appendChild(artPiece);
            });
            
            // 2-5. ì§€ì—° ë¡œë“œ(Lazy Loading) ë° 3-1. í™•ëŒ€ ë³´ê¸° ê¸°ëŠ¥ í™œì„±í™”
            activateFeatures();
        }
        
        // --- 2-5. ì§€ì—° ë¡œë“œ(Lazy Loading) ë° 3-1. í™•ëŒ€ ë³´ê¸° ê¸°ëŠ¥ í•¨ìˆ˜ ---
        function activateFeatures() {
            // 2-5. Intersection Observer ì„¤ì • (ì§€ì—° ë¡œë“œ)
            const lazyArtFrames = document.querySelectorAll('.art-frame');
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const iframe = entry.target;
                        // data-srcì˜ ê°’ì„ srcë¡œ ì´ë™ì‹œì¼œ ë¡œë”© ì‹œì‘
                        if (iframe.dataset.src) {
                            iframe.src = iframe.dataset.src;
                            iframe.removeAttribute('data-src');
                        }
                        // í•œ ë²ˆ ë¡œë“œëœ iframeì€ ê´€ì°°ì„ ë©ˆì¶¥ë‹ˆë‹¤.
                        observer.unobserve(iframe);
                    }
                });
            }, {
                rootMargin: '0px 0px 200px 0px', // 200px ë¯¸ë¦¬ ë¡œë“œ (ì‚¬ìš©ì ê²½í—˜ ê°œì„ )
            });

            lazyArtFrames.forEach(iframe => {
                observer.observe(iframe);
            });

            // 3-1. ì‘í’ˆ í™•ëŒ€ ë³´ê¸° ê¸°ëŠ¥ (ìƒˆ ì°½ íŒì—…)
            document.querySelectorAll('.art-piece').forEach(piece => {
                piece.addEventListener('click', function() {
                    const p5jsUrl = this.dataset.url;
                    // í™•ëŒ€ ì°½ í¬ê¸°ëŠ” ê°¤ëŸ¬ë¦¬ ê·œê²©ë³´ë‹¤ í¬ê²Œ ì„¤ì •
                    const popupWidth = Math.min(parseInt(frameWidth) + 300, 1200); 
                    const popupHeight = Math.min(parseInt(frameHeight) + 200, 800);

                    if (p5jsUrl) {
                        window.open(
                            p5jsUrl, 
                            '_blank', 
                            `width=${popupWidth},height=${popupHeight},scrollbars=yes,resizable=yes`
                        );
                    }
                });
            });
        }
    </script>
